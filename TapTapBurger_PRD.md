# Tab Tab Burger: Perfect Order — PRD

> 문서 상태 (2026-02-16)
> - 이 문서는 `기획 의도(PRD)`와 `현재 구현 스펙(Code Truth)`를 함께 관리합니다.
> - 본문(특히 5장~10장)의 기존 설명은 초기 기획 기준을 유지합니다.
> - 현재 코드와 충돌하는 수치/룰/UI는 `12. Current Spec (Code Truth)`를 우선 참조합니다.
> - `13. Fever Time Spec (v1)`은 합의된 신규 기능 사양이며, 구현은 다음 단계에서 진행합니다.

## 1. 개요

| 항목 | 내용 |
|---|---|
| 프로젝트명 | Tab Tab Burger: Perfect Order |
| 장르 | 리듬 / 캐주얼 아케이드 |
| 플랫폼 | 웹 (PC / 모바일) |
| 프론트엔드 | Next.js 15, SCSS |
| 백엔드 / API | Supabase (CLI 기반) |

### 게임 개요
주문서에 적힌 순서대로 햄버거 재료를 조합하여 제출하는 타이밍 기반 캐주얼 게임. 주문이 쌓일수록 난이도가 올라가고, HP가 0이 되면 게임 오버.

---

## 2. 목표 및 성공 지표

### 목표
- PC와 모바일 모두에서 쾌적하게 플레이 가능한 웹 게임 구현
- 싱글 / 협력 / 대전 세 가지 모드 제공
- 전 세계 유저와 리더보드 경쟁 가능한 소셜 경쟁 요소 제공

### 성공 지표
- 싱글 플레이 평균 세션 시간 3분 이상
- 멀티 모드 진입률 전체 유저의 20% 이상
- 리더보드 상위권 재방문율

---

## 3. 유저 시나리오

| 유형 | 설명 |
|---|---|
| 캐주얼 유저 | 짧은 세션, 싱글 플레이, 점수 갱신 목적 |
| 소셜 유저 | 친구와 협력 또는 대전 모드 링크 공유 |
| 경쟁 유저 | 리더보드 최상위 도전, 콤보 최대화 전략 추구 |

---

## 4. 페이지 구성

### 4.1 메인 페이지 (`/`)
- 게임 타이틀 표시
- 닉네임 입력 필드 (미입력 시 `player` + 4자리 랜덤 숫자 자동 생성)
- 버튼
  - [싱글 게임 시작]
  - [멀티 게임]
  - [리더보드]
  - [하우 투 플레이]

### 4.2 싱글 게임 페이지 (`/game/single`)
- 인 게임 UI 전체 구성 (§6 참고)
- 게임 오버 시 결과 화면 (점수, 최대 콤보, 리더보드 등록 여부)

### 4.3 리더보드 페이지 (`/leaderboard`)
- 탭: 싱글 / 협력 / 대전
- 표시 항목: 순위, 닉네임, 최고 점수, 최대 콤보
- 상위 100위 표시, 자신의 순위 하이라이트

### 4.4 멀티 게임 허브 페이지 (`/game/multi`)
- [협력 모드] / [대전 모드] 버튼
- 버튼 클릭 시 고유 링크 생성 및 클립보드 복사
- 방장: 링크 공유 후 대기 화면 표시
- 참가자: 링크 접속 → 닉네임 입력 → [준비] 버튼 활성화
- 참가자가 준비 완료 시 방장의 [게임 시작] 버튼 활성화
- 현재 접속 인원 및 준비 상태 실시간 표시

### 4.5 협력 게임 페이지 (`/game/coop/:roomId`)
- 협력 모드 인 게임 UI

### 4.6 대전 게임 페이지 (`/game/versus/:roomId`)
- 대전 모드 인 게임 UI

---

## 5. 게임 메카닉

### 5.1 HP 시스템
- 화면 최상단에 HP 바 표시
- HP 최대값: **100**, 초기값: **80**
- 시간 경과에 따라 HP 자동 감소 (점수 구간별 속도 상이, §5.6 참고)
- HP 변화량:

  | 이벤트 | HP 변화 |
  |---|---|
  | 버거 정상 제출 | +15 |
  | 콤보 달성 정상 제출 | +20 |
  | 버거 잘못 제출 | -20 |
  | 주문서 시간 초과 | -25 |

- HP = 0 → 게임 오버

### 5.2 주문서 큐 (Order Queue)
- HP 바 아래에 주문서 큐 표시
- 주문서는 오른쪽에서 등장하여 왼쪽으로 이동하며 순서대로 쌓임
- 화면에 최대 3개 주문서 노출, 초과분은 `+N개` 표시
- 주문서에는 버거 재료가 **위에서 아래로 순서대로** 기재됨
- 현재 입력한 재료에 해당하는 항목에 밑줄 표시(입력 인식 피드백)
- 재료가 많아져 주문서가 길어질 경우, 입력된 재료 위치로 자동 스크롤

### 5.3 주문서 타이머
- 각 주문서마다 제한 시간 존재
- **타이머 계산 공식:**
  - 1번째 주문서 제한 시간 = 재료 수 × 기본 1초
  - N번째 주문서 제한 시간 = (N-1)번째 주문서 제한 시간 + 재료 수 × 1초
- 제한 시간 내 제출하지 못하면 HP 감소 후 해당 주문서 소멸
- 제한 시간의 2/3 이내에 제출 시 **콤보** 인정

### 5.4 버거 조합 입력
- 입력 키 맵핑 (PC 기준):

  | 키 | 재료 |
  |---|---|
  | ↑ / W | 패티 (Patty) |
  | ↓ / S | 치즈 (Cheese) |
  | ← / A | 야채 (Veggies) |
  | → / D | 소스 (Sauce) |
  | ESC / Backspace | 마지막 재료 취소 |
  | Enter / Space | 버거 제출 (위 번 덮기) |

- 모바일: 화면 하단 UI 버튼으로 동일 기능 작동 (터치)
- 입력한 재료는 화면 중앙 버거 스택에 아래에서 위로 쌓임
- 제출 시 위 번(Top Bun)이 자동으로 올라가며 버거 완성 연출

### 5.5 채점 및 판정
- 기본 제출 점수: **100점**

| 상황 | 점수 | HP |
|---|---|---|
| 재료 순서 정확 + 제한 시간 내 제출 | 100점 × 콤보 배율 | +15 |
| 재료 순서 정확 + 제한 시간 2/3 이내 제출 | 100점 × 콤보 배율 + **콤보** | +20 |
| 재료 순서 불일치 | 0점 | -20 |
| 주문서 시간 초과 | 0점, 주문서 소멸 | -25 |

### 5.6 난이도 스케일링
- 주문서 최대 재료 수 상한선: **12개**
- 점수 구간별 재료 수 / 타이머 배율 / HP 자동 감소 속도:

  | 점수 구간 | 최대 재료 수 | 타이머 배율 | HP 자동 감소 (초당) |
  |---|---|---|---|
  | 0 ~ 199 | 3개 | ×1.0 | 2 |
  | 200 ~ 499 | 4개 | ×0.85 | 2 |
  | 500 ~ 899 | 5개 | ×0.70 | 3 |
  | 900 ~ 1399 | 6개 | ×0.60 | 3 |
  | 1400 이상 | 7개 | ×0.50 (하한) | 4 (상한) |

### 5.7 콤보 시스템
- 콤보: 제한 시간의 2/3 이내 연속 정확 제출
- 콤보 횟수별 점수 배율:

  | 연속 콤보 | 점수 배율 | 획득 점수 |
  |---|---|---|
  | 1 ~ 2 | ×1.5 | 150점 |
  | 3 ~ 5 | ×2.0 | 200점 |
  | 6 ~ 9 | ×3.0 | 300점 |
  | 10 이상 | ×5.0 | 500점 |

- 콤보 실패(잘못 제출 또는 시간 초과) 시 콤보 초기화

### 5.8 현재 구현 우선 규칙
- 5장의 상세 수치/룰은 초기 기획 기준을 유지한다.
- 실제 구현과 충돌하는 경우 `12. Current Spec (Code Truth)`를 기준으로 판단한다.
- 신규 기능(피버타임 등)의 결정 사양은 `13. Fever Time Spec (v1)`을 기준으로 한다.

---

## 6. 인 게임 UI 레이아웃 (모바일 기준)

```
[ HP BAR =====================———— ]

[ 주문서1 ] [ 주문서2 ] [ 주문서3 ]  +N

             [ 버거 스택 영역 ]

 [ 취소 ]                  [ 제출 ]
 [ 야채 ]                  [ 소스 ]
 [ 치즈 ]    (버거 이미지)  [ 패티 ]
```

- PC에서도 동일 레이아웃 사용 (반응형), 키보드 입력 병행
- 주문서 영역: 가로 스크롤 가능 (큐 항목 확인용)
- 버거 스택 영역: 중앙 배치, 재료 쌓임 애니메이션
- 입력 버튼: 하단 4분할 그리드

---

## 7. 멀티플레이어 모드

### 7.1 공통 규칙
- 고유 룸 링크 생성 → 상대방 링크로 접속 → 닉네임 입력 → 준비 → 게임 시작
- Supabase Realtime을 이용한 실시간 동기화

### 7.2 협력 모드 (Co-op)
- 6개 입력 키(패티, 치즈, 야채, 소스, 취소, 제출)를 두 플레이어에게 랜덤 3개씩 분배
- 두 플레이어가 서로 다른 키를 담당하므로 소통 및 협력 필수
- 점수 / HP는 공유
- 결과: 협력 리더보드 등록

### 7.3 대전 모드 (Versus)
- 두 플레이어가 각각 독립적인 게임 진행
- **화면 구성:**
  - 모바일/PC: 하단 80% = 내 게임 플레이 영역 / 상단 미니 패널 = 상대 HP + 주문 큐 수 표시
- **방해 메카닉:** 상대방이 콤보 달성 시 → 내 큐에 주문서 수량 및 난이도 상승 (콤보 횟수만큼)
- 상대방 HP, 주문 큐 상태 실시간 표시
- 상대방 HP = 0 → 게임 종료, 내가 승리
- 내 HP = 0 → 패배
- 결과: 대전 리더보드 등록

---

## 8. 기술 요구사항

### 8.1 프론트엔드
- **Framework:** Next.js 15 (App Router)
- **Styling:** SCSS Modules
- **State Management:** Zustand (게임 상태) 또는 React Context (필요 시)
- **Realtime:** Supabase Realtime (멀티플레이어 동기화)
- **Animation:** CSS Animation / Framer Motion (버거 스택, 주문서 등장 효과)
- **디자인 무드:** NES 스타일 픽셀 아트
- **픽셀 UI 라이브러리:** `@girgir/pixel-borders-modern`
  - 버튼, 인풋, 카드/박스 등 모든 기본 컴포넌트에 픽셀 테두리 적용
  - `pixel-borders()` / `pixel-box()` SCSS 믹스인 사용
- **반응형:** 모바일 우선, 최대 너비 768px 고정
  - `768px 초과`: 콘텐츠 영역을 `max-width: 768px` 로 중앙 정렬, 양옆 여백 발생
  - `768px 이하`: 모든 레이아웃 수치를 `vw` 단위 기반으로 비율 스케일링 (고정 px 사용 금지)
  - 기준 뷰포트: 375px (iPhone SE 기준), 모든 컴포넌트 크기를 이 너비 대비 비율로 정의
  - 예: `font-size: 4.26vw` = 375px 기준 16px에 해당

### 8.1.1 디자인 시스템

#### 픽셀 UI 라이브러리 설치
```bash
npm install @girgir/pixel-borders-modern --save-dev
```

#### 컴포넌트별 믹스인 적용 규칙

| 컴포넌트 | 믹스인 | 주요 파라미터 |
|---|---|---|
| 기본 버튼 | `pb.pixel-borders()` | `$corner-size: 2`, `$border-size: 4px` |
| 인풋 필드 | `pb.pixel-borders()` | `$corner-size: 1`, `$border-size: 3px` |
| 카드 / 박스 | `pb.pixel-box()` | inset 스타일 적용 |
| 주문서 카드 | `pb.pixel-box()` | 강조 색상 테두리 |
| HP 바 컨테이너 | `pb.pixel-borders()` | `$border-size: 2px` (얇게) |

#### 공통 컬러 팔레트

| 토큰 | 색상 | 용도 |
|---|---|---|
| `$color-bg` | `#1a1a2e` | 전체 배경 (다크 네이비) |
| `$color-surface` | `#16213e` | 카드 / 박스 배경 |
| `$color-primary` | `#f5a623` | 버튼 강조, HP 바 |
| `$color-danger` | `#e94560` | 위험 / 게임 오버 / HP 감소 |
| `$color-success` | `#4caf50` | 콤보 / 정상 제출 피드백 |
| `$color-border` | `#ffffff` | 픽셀 테두리 기본색 |
| `$color-text` | `#eaeaea` | 기본 텍스트 |

#### 픽셀 폰트
- `Mulmaru` — 기본 픽셀 폰트
```
@font-face {
    font-family: 'Mulmaru';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2601-4@1.1/Mulmaru.woff2') format('woff2');
    font-weight: normal;
    font-display: swap;
}
```
### 8.2 백엔드 / DB (Supabase)
- **Auth:** 익명 세션 기반 (닉네임만 입력, 별도 회원가입 없음)
- **Database 테이블:**

  | 테이블 | 주요 컬럼 |
  |---|---|
  | `players` | id (UUID PK), session_id (UUID, UNIQUE), nickname, updated_at, created_at |
  | `scores` | id, player_id, mode (single/coop/versus), score, max_combo, created_at — UNIQUE(player_id, mode) |
  | `rooms` | id, mode, status, created_at |
  | `room_players` | id, room_id, player_id, ready, assigned_keys (coop용) |

- **Realtime:** 룸 상태, 플레이어 준비 상태, 게임 이벤트 동기화
- **RLS (Row Level Security):** 룸 접근 제한, session_id 일치 시에만 자신의 데이터 수정 가능

### 8.3 플레이어 식별 및 스코어 중복 방지

#### 식별 방식
- 최초 접속 시 클라이언트(브라우저)에서 UUID v4를 생성하여 `localStorage`에 저장 (`ttb_session_id`)
- 이후 모든 재접속에서 동일 UUID 재사용 → 닉네임이 바뀌어도 동일 플레이어로 인식
- `players` 테이블에 `session_id` 컬럼으로 저장, UNIQUE 제약으로 중복 방지

#### 스코어 등록 정책
- `scores` 테이블에 `(player_id, mode)` 조합으로 UNIQUE 제약 설정
- 게임 종료 시 `UPSERT`: 기존 최고 점수보다 높을 때만 덮어씀
  ```sql
  INSERT INTO scores (player_id, mode, score, max_combo)
  VALUES (...)
  ON CONFLICT (player_id, mode)
  DO UPDATE SET
    score     = GREATEST(scores.score, EXCLUDED.score),
    max_combo = GREATEST(scores.max_combo, EXCLUDED.max_combo);
  ```
- 리더보드는 `player_id` 기준으로 집계 → 동일 플레이어가 여러 번 게임해도 최고 기록 1개만 노출

#### 고려 케이스

| 케이스 | 처리 방식 |
|---|---|
| 닉네임 변경 후 게임 | `session_id` 유지 → `players.nickname` 만 UPDATE, 점수 중복 없음 |
| 게임 도중 닉네임 변경 | 게임 시작 시점 닉네임으로 결과 저장 (게임 중 변경 불가) |
| 브라우저 캐시/localStorage 초기화 | 새 UUID 생성 → 신규 플레이어로 취급, 이전 기록과 연결 불가 (의도적 단절) |
| 다른 기기 / 다른 브라우저 접속 | 새 UUID → 별개 플레이어로 독립 기록 (크로스 기기 동기화는 스코프 외) |
| 동명이인 (같은 닉네임, 다른 UUID) | UUID가 다르므로 리더보드에 별도 등록 (닉네임 중복 허용) |
| 비정상 종료 / 탭 닫기 | 게임 결과 미저장 (게임 완료 — HP 0 도달 — 시점에만 저장) |

### 8.4 배포
- **Frontend:** Vercel (Next.js 권장)
- **Backend:** Supabase Cloud

---

## 9. 비기능 요구사항

| 항목 | 요구사항 |
|---|---|
| 성능 | 60fps 유지, 입력 레이턴시 < 50ms |
| 접근성 | 키보드 / 터치 모두 지원 |
| 브라우저 지원 | Chrome, Safari, Firefox 최신 버전 |
| 모바일 최적화 | iOS Safari, Android Chrome 대응 |
| 반응형 | max-width 768px 중앙 정렬 / 768px 이하 vw 비율 스케일 |

---

## 10. 게임 수치 요약

| 항목 | 수치 |
|---|---|
| HP 최대값 | 100 |
| HP 초기값 | 80 |
| HP 자동 감소 속도 | 초당 2~4 (점수 구간별 증가) |
| 정상 제출 HP 회복 | +15 |
| 콤보 제출 HP 회복 | +20 |
| 잘못 제출 HP 감소 | -20 |
| 시간 초과 HP 감소 | -25 |
| 기본 제출 점수 | 100점 |
| 콤보 배율 | ×1.5 / ×2.0 / ×3.0 / ×5.0 |
| 주문서 최대 재료 수 | 7개 |
| 타이머 최소 배율 (하한) | ×0.50 |
| 멀티플레이어 인원 | 2인 (1:1 고정) |
| 대전 모드 UI (모바일) | 상단 70% 내 게임 + 하단 상대 미니 패널 |
| 대전 모드 UI (PC) | 좌우 50% 분할 화면 |

---

## 11. 스코프 외 (Out of Scope)

- 회원가입 / 로그인 시스템
- 인앱 결제 / 광고
- 3인 이상 멀티플레이
- 모바일 네이티브 앱 (PWA는 고려 가능)

---

## 12. Current Spec (Code Truth)

이 장은 현재 코드 구현(`src/*`)과 1:1로 대응되는 실제 동작 스펙이다.

### 12.1 코어 수치

- HP: `MAX 100`, `INIT 100`
- HP 변화량:

  | 이벤트 | HP 변화 |
  |---|---|
  | 정답 제출 | +15 |
  | 콤보 제출 | +20 |
  | 오답 제출 | -10 |
  | 주문 타임아웃 | -20 |

- 콤보 판정: `elapsed < timeLimit * 0.65`
- 기본 점수: `100`
- 콤보 배율: `1~2: 1.5 / 3~5: 2.0 / 6~9: 3.0 / 10+: 5.0`
- 입력 잠금: 정답 제출/타임아웃 직후 `200ms`

### 12.2 주문/난이도 로직

- 초기 주문 수: `3`
- 주문 처리: `FIFO`
- 타이머 진행: `첫 주문(orders[0])만` 진행
- 난이도 기준: 점수 기반이 아니라 `orderCounter`(누적 주문 인덱스) 기반
- 난이도 티어:

  | minOrders | minIngredients | timerMultiplier | hpDrainPerSec |
  |---|---|---|---|
  | 0 | 3 | 2.2 | 0.4 |
  | 6 | 4 | 2.0 | 0.8 |
  | 10 | 5 | 1.8 | 1.2 |
  | 15 | 6 | 1.6 | 1.6 |
  | 20 | 7 | 1.4 | 2.2 |
  | 25 | 8 | 0.8 | 3.2 |
  | 30 | 9 | 0.6 | 4.5 |
  | 45 | 11 | 0.46 | 6.0 |
  | 50 | 12 | 0.38 | 8.0 |

- 멀티 최대 재료 수: `6` (`MULTI_MAX_INGREDIENTS`)

### 12.3 입력 규칙

- 키 매핑: `WASD + Q/E + ESC/BACKSPACE + ENTER/SPACE`
- 화살표 키 매핑은 현재 코드에 없음
- 코업 키 분배: 각 플레이어 `재료 3개 + submit`
- 코업에서 `cancel`은 현재 배정되지 않음

### 12.4 UI/플로우

- 싱글/코업/대전 인게임 본화면은 `OrderQueue 3장`이 아니라 `OrderPreview 1장` 중심
- 카운트다운: `3, 2, 1, GO!` 후 게임 시작
- 오답: 화면 흔들림
- 타임아웃: 붉은 비네트
- 콤보: 중앙 팝업
- 대전 HUD:
  - 상대 미니 패널(닉네임, HP, clears, score, combo, target burger)
  - 공격 송신 배너
  - 피격 오버레이 + 강한 화면 흔들림
- 대전 공격 트리거:
  - 콤보 달성 시점이 아니라 `콤보가 0으로 종료되는 순간`
- 대전 공격 효과:
  - 상대 큐에 새 주문서를 추가하는 방식이 아니라 `마지막 주문 재료 추가 + timeLimit 연장`

---

## 13. Fever Time Spec (v1)

본 장은 팀 합의 기반의 기능 명세이며, 구현 전 기준 문서로 사용한다.

### 13.1 트리거/대상

- 트리거: 누적 클리어 기준 `5번째 주문마다` 발동
- 적용 모드: `single`, `coop`, `versus` 전체

### 13.2 피버 주문 규칙

- 주문서 타입: `특수 주문(Fever)`
- 주문서 표기:
  - 제목: `피버 타임!`
  - 랜덤 지정 재료 이미지 노출
  - 안내 문구: `시간 내에 가장 많이 쌓아서 완성하세요!`
- 시간 제한: `6초`
- 행동:
  - 지정된 재료만 무한 입력 가능
  - 제한 시간 내 `완성(submit)` 누르면 성공
- 점수: `적재 개수 * 50`
- 콤보: 기존 콤보를 무조건 유지 (피버 중 콤보 증가/초기화 없음)

### 13.3 모드별 세부

- 싱글: 피버 종료 후 일반 주문 루프로 복귀
- 코업: 피버 동안 두 플레이어 모두 지정 재료 입력 권한 허용
- 대전:
  - 피버 중 기존 콤보 공격 비활성
  - 피버 종료 시 `Delta Burst` 1회 적용

### 13.4 Delta Burst 규칙 (Versus)

- 양측 피버 적재수 비교: `diff = 내 적재수 - 상대 적재수`
- 공격 변환:

  | diff | 공격치 |
  |---|---|
  | 0~2 | 0 |
  | 3~5 | 1 |
  | 6~8 | 2 |
  | 9+ | 3 |

- 상대에게 난이도 가중 1회 적용 (기존 `addOrdersFromAttack` 계열 방식)
- 안전장치:
  - 최대 공격치 `3`
  - 피버 종료 후 `2초` 재공격 금지 쿨다운

### 13.5 중요 인터페이스/타입 변경

1. `Order` 확장
   - `type: 'normal' | 'fever'`
   - `feverIngredient?: Ingredient`
2. `GameState` 확장
   - `isFeverActive`, `feverIngredient`, `feverEndAt`, `feverStackCount`
3. 대전 동기화 payload 확장
   - `feverStackCount`, `isFeverActive` 동기화 필드
4. 공격 이벤트 타입 확장
   - `attack_type: 'combo' | 'fever_delta'`

### 13.6 테스트 케이스 및 시나리오

1. 5클리어마다 피버 주문이 정확히 생성된다.
2. 피버에서 지정 재료 외 입력이 무시된다.
3. 피버 6초 내 submit 성공 시 `stack*50` 점수가 반영된다.
4. 피버 성공/실패와 무관하게 기존 콤보 값이 유지된다.
5. 코업 피버에서 양측 모두 입력 가능하다.
6. 대전 피버 중 기존 콤보 공격이 발생하지 않는다.
7. 대전 피버 종료 시 Delta Burst가 0~3 범위로 1회만 적용된다.
8. 피버 종료 후 2초 내 추가 피버 공격이 차단된다.

### 13.7 명시적 가정 및 기본값

- `Current Spec`이 PRD 본문과 충돌할 경우, 현재는 코드 기준 우선으로 기록한다.
- 기존 PRD의 비전/목표/스코프는 유지하고, 수치/룰/UI는 `Current Spec`에서 관리한다.
- Fever는 점수 강화 이벤트이며, 기본 밸런스 파괴를 막기 위해 공격량 상한과 쿨다운을 둔다.
- 이번 작업은 문서 정합성 확립이 목적이며, 구현 변경은 다음 단계로 분리한다.
